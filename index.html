<!DOCTYPE html>
<html> <!-- 定义HTML文档开始 -->
<head> <!-- 文档头部，包含元信息和样式 -->
    <title>您的资料下载站</title> <!-- 浏览器标签页显示的标题 -->
    <style> <!-- 内联样式表 -->
        body {  /* 设置整个页面的基础样式 */
            font-family: sans-serif;  /* 使用无衬线字体 */
            text-align: center;       /* 文本居中对齐 */
            padding: 200px;           /* 内边距，使内容垂直居中 */
        }
        input, button {  /* 设置输入框和按钮的样式 */
            padding: 10px;  /* 内边距 */
            margin: 10px;   /* 外边距 */
        }
    </style>
</head>
<body> <!-- 文档主体，包含所有可见内容 -->
    <h2>请输入您的淘宝订单号</h2> <!-- 页面主标题 -->
    <input type="text" id="orderId" placeholder="例如: 120"> <!-- 订单号输入框，id用于JS获取值，placeholder是输入提示 -->
    <button onclick="verifyOrder()">验证并下载</button> <!-- 按钮，点击时触发verifyOrder函数 -->
    <div id="message"></div> <!-- 用于显示操作状态消息的容器，初始为空 -->
    
    <script> <!-- JavaScript代码开始 -->
        // ！！！重要：将此地址替换为你实际的Cloudflare Worker地址！！！
        // 例如：https://shop-api.你的子域名.workers.dev 或 https://api.你的域名.com
        const WORKER_API_URL = "https://shop-api.你的域名.workers.dev"; // 定义后端API的基础地址常量

        // 主函数：验证订单并触发下载
        async function verifyOrder() { // 声明一个异步函数，因为内部有网络请求
            const orderId = document.getElementById('orderId').value.trim(); // 获取输入框的值，并去除首尾空格
            const messageEl = document.getElementById('message'); // 获取显示消息的DOM元素

            if (!orderId) { // 检查订单号是否为空
                messageEl.textContent = "请输入订单号"; // 显示错误信息
                messageEl.style.color = "red"; // 将信息颜色设置为红色
                return; // 终止函数执行
            }

            messageEl.textContent = "正在验证订单..."; // 显示验证中的状态
            messageEl.style.color = "blue"; // 将信息颜色设置为蓝色

            try { // 尝试执行以下可能出错的代码
                // 步骤1: 调用后端验证接口，检查订单号是否有效
                const verifyResponse = await fetch(`${WORKER_API_URL}/api/verify`, { // 发送POST请求到验证接口，await等待响应
                    method: 'POST', // 请求方法为POST
                    headers: { // 设置请求头
                        'Content-Type': 'application/json' // 告知服务器发送的是JSON数据
                    },
                    body: JSON.stringify({ orderId: orderId }) // 将订单号对象转换为JSON字符串作为请求体
                });

                const result = await verifyResponse.json(); // 将响应体解析为JSON对象，await等待解析完成

                if (!result.success) { // 如果后端返回success字段为false（验证失败）
                    messageEl.textContent = `验证失败：${result.message || "订单号无效"}`; // 显示失败信息，使用后端消息或默认消息
                    messageEl.style.color = "red"; // 将信息颜色设置为红色
                    return; // 终止函数执行
                }

                // 验证成功，从响应结果中提取令牌(token)和文件名(fileKey)
                const { token, fileKey } = result; // 使用解构赋值，等同于 const token = result.token; const fileKey = result.fileKey;
                messageEl.textContent = "验证成功，准备下载..."; // 更新状态信息
                messageEl.style.color = "green"; // 将信息颜色设置为绿色

                // 步骤2: 使用获取到的令牌，请求下载文件
                const downloadResponse = await fetch(`${WORKER_API_URL}/api/download/${fileKey}`, { // 发送GET请求到下载接口，文件名包含在URL中
                    method: 'GET', // 请求方法为GET
                    headers: { // 设置请求头
                        'Authorization': `Bearer ${token}` // 关键：在Authorization头中携带令牌，格式为"Bearer <token>"
                    }
                });

                if (!downloadResponse.ok) { // 如果HTTP响应状态码不是2xx（如404、403等）
                    throw new Error(`下载失败: ${downloadResponse.status}`); // 抛出一个错误，会被下面的catch块捕获
                }

                // 步骤3: 处理文件流，触发浏览器下载
                const blob = await downloadResponse.blob(); // 将响应体转换为Blob（二进制大对象）对象，代表文件数据
                const downloadUrl = window.URL.createObjectURL(blob); // 为该Blob创建一个临时的本地URL
                const link = document.createElement('a'); // 创建一个隐藏的<a>链接元素
                link.href = downloadUrl; // 设置链接的地址为临时URL
                link.download = fileKey; // 设置download属性，指定浏览器下载的文件名
                link.style.display = 'none'; // 将链接隐藏，不显示在页面上

                document.body.appendChild(link); // 将链接添加到页面DOM中（必须添加才能触发点击）
                link.click(); // 模拟用户点击该链接，触发下载
                document.body.removeChild(link); // 下载触发后，立即从DOM中移除该链接
                window.URL.revokeObjectURL(downloadUrl); // 释放创建的临时URL所占用的内存

                messageEl.textContent = "文件下载已开始！如果未自动下载，请检查浏览器设置。"; // 显示最终成功信息
                messageEl.style.color = "green"; // 将信息颜色设置为绿色

            } catch (error) { // 捕获并处理上面try块中抛出的任何错误（网络错误、API错误、逻辑错误等）
                console.error("下载过程出错:", error); // 在浏览器控制台输出详细错误，便于调试
                messageEl.textContent = `错误: ${error.message || "请检查网络连接或稍后重试"}`; // 在页面显示用户友好的错误信息
                messageEl.style.color = "red"; // 将信息颜色设置为红色
            }
        }

        // 增强用户体验：在订单号输入框按回车键，等同于点击“验证并下载”按钮
        document.getElementById('orderId').addEventListener('keypress', function(event) { // 为输入框添加键盘按键事件监听器
            if (event.key === 'Enter') { // 判断按下的键是否是“回车键”
                verifyOrder(); // 如果是，则调用主验证函数
            }
        });
    </script> <!-- JavaScript代码结束 -->
</body> <!-- 文档主体结束 -->
</html> <!-- HTML文档结束 -->
